name: Rebalancing E2E Tests

on:
  pull_request:
    paths:
      - "danube-broker/src/danube_service/load_manager/**"
      - "danube-broker/src/danube_service/load_manager.rs"
      - "config/for_tests/danube_broker_rebalance.yml"
      - ".github/workflows/danube-rebalance-e2e.yml"
  workflow_dispatch: # Allow manual trigger

jobs:
  rebalancing_e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      etcd:
        image: quay.io/coreos/etcd:v3.5.22
        ports:
          - 2379:2379
        env:
          ETCD_NAME: etcd-danube
          ETCD_ADVERTISE_CLIENT_URLS: http://0.0.0.0:2379
          ETCD_LISTEN_CLIENT_URLS: http://0.0.0.0:2379

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq netcat-openbsd protobuf-compiler bc

      - name: Wait for etcd to be ready
        run: |
          for i in {1..10}; do
            if nc -zv 127.0.0.1 2379; then
              echo "etcd is ready."
              break
            elif [ $i -eq 10 ]; then
              echo "etcd failed to start."
              exit 1
            fi
            echo "Waiting for etcd to start..."
            sleep 3
          done

      - name: Create certificate files
        run: |
          mkdir -p ./cert
          printf "%s" "${{ secrets.CERT_FILE }}" > ./cert/server-cert.pem
          printf "%s" "${{ secrets.KEY_FILE }}" > ./cert/server-key.pem
          printf "%s" "${{ secrets.CA_FILE }}" > ./cert/ca-cert.pem

      - name: Build workspace (release)
        run: cargo build --workspace --release

      - name: Start Broker 1
        env:
          RUST_LOG: info
        run: |
          nohup ./target/release/danube-broker \
            --config-file ./config/for_tests/danube_broker_rebalance.yml \
            --broker-addr 0.0.0.0:6650 \
            --admin-addr 0.0.0.0:50051 \
            --prom-exporter 0.0.0.0:9040 \
            > broker-1.log 2>&1 &

          for i in {1..15}; do
            if nc -zv 127.0.0.1 50051 && nc -zv 127.0.0.1 6650; then
              echo "Broker 1 is ready."
              break
            elif [ $i -eq 15 ]; then
              echo "Broker 1 failed to start."
              cat broker-1.log
              exit 1
            fi
            echo "Waiting for Broker 1 to start... ($i/15)"
            sleep 3
          done

      - name: Start Broker 2
        env:
          RUST_LOG: info
        run: |
          nohup ./target/release/danube-broker \
            --config-file ./config/for_tests/danube_broker_rebalance.yml \
            --broker-addr 0.0.0.0:6651 \
            --admin-addr 0.0.0.0:50052 \
            --prom-exporter 0.0.0.0:9041 \
            > broker-2.log 2>&1 &

          for i in {1..15}; do
            if nc -zv 127.0.0.1 50052 && nc -zv 127.0.0.1 6651; then
              echo "Broker 2 is ready."
              break
            elif [ $i -eq 15 ]; then
              echo "Broker 2 failed to start."
              cat broker-2.log
              exit 1
            fi
            echo "Waiting for Broker 2 to start... ($i/15)"
            sleep 3
          done

      - name: Start Broker 3
        env:
          RUST_LOG: info
        run: |
          nohup ./target/release/danube-broker \
            --config-file ./config/for_tests/danube_broker_rebalance.yml \
            --broker-addr 0.0.0.0:6652 \
            --admin-addr 0.0.0.0:50053 \
            --prom-exporter 0.0.0.0:9042 \
            > broker-3.log 2>&1 &

          for i in {1..15}; do
            if nc -zv 127.0.0.1 50053 && nc -zv 127.0.0.1 6652; then
              echo "Broker 3 is ready."
              break
            elif [ $i -eq 15 ]; then
              echo "Broker 3 failed to start."
              cat broker-3.log
              exit 1
            fi
            echo "Waiting for Broker 3 to start... ($i/15)"
            sleep 3
          done

          # Give brokers time to discover each other
          echo "Waiting for cluster discovery..."
          sleep 10

      - name: "Phase 1: Cluster Setup & Validate Balanced State"
        env:
          DANUBE_ADMIN_ENDPOINT: http://127.0.0.1:50051
        run: |
          echo "========================================="
          echo "Phase 1: Cluster Setup & Validate Balanced State"
          echo "========================================="

          # Get broker IDs dynamically
          BROKER_IDS=$(./target/release/danube-admin-cli brokers list --output json | jq -r '.[].broker_id')
          BROKER_1=$(echo "$BROKER_IDS" | sed -n '1p')
          BROKER_2=$(echo "$BROKER_IDS" | sed -n '2p')
          BROKER_3=$(echo "$BROKER_IDS" | sed -n '3p')

          echo "Broker IDs:"
          echo "  Broker 1: $BROKER_1"
          echo "  Broker 2: $BROKER_2"
          echo "  Broker 3: $BROKER_3"

          # Save broker IDs for later steps
          echo "$BROKER_1" > broker-1-id.txt
          echo "$BROKER_2" > broker-2-id.txt
          echo "$BROKER_3" > broker-3-id.txt

          # Create 12 topics (LoadManager distributes evenly)
          echo ""
          echo "Creating 12 test topics..."
          for i in {1..12}; do
            ./target/release/danube-admin-cli topics create /default/test-topic-$i
          done

          sleep 5

          # Verify exactly 12 topics were created
          echo ""
          echo "Listing all topics..."
          TOPIC_COUNT=$(./target/release/danube-admin-cli topics list --namespace default | grep -c "Topic:" || true)
          echo "Total topics created: $TOPIC_COUNT"
          ./target/release/danube-admin-cli topics list --namespace default

          if [ "$TOPIC_COUNT" -ne 12 ]; then
            echo "✗ Expected 12 topics but found $TOPIC_COUNT"
            exit 1
          fi
          echo "✓ Verified 12 topics exist"

          # Verify cluster is balanced (LoadManager distributed topics evenly)
          echo ""
          echo "Checking cluster balance..."
          ./target/release/danube-admin-cli brokers balance

          CV=$(./target/release/danube-admin-cli brokers balance --output json | jq -r '.coefficient_of_variation')
          echo ""
          echo "Coefficient of Variation: $CV"

          # Expect CV < 0.30 (balanced)
          if (( $(echo "$CV < 0.30" | bc -l) )); then
            echo "✓ Cluster is balanced (CV=$CV)"
          else
            echo "✗ Expected balanced cluster but CV=$CV"
            ./target/release/danube-admin-cli brokers balance
            exit 1
          fi

          # Verify topics distributed across brokers
          echo ""
          echo "Topic distribution (from balance report):"
          BALANCE_JSON=$(./target/release/danube-admin-cli brokers balance --output json)
          TOTAL_FROM_BALANCE=0
          for broker_id in $BROKER_1 $BROKER_2 $BROKER_3; do
            count=$(echo "$BALANCE_JSON" | jq -r --arg broker "$broker_id" '.brokers[] | select(.broker_id == ($broker | tonumber)) | .topic_count')
            count=${count:-0}
            echo "  Broker $broker_id: $count topics"
            TOTAL_FROM_BALANCE=$((TOTAL_FROM_BALANCE + count))
          done

          echo ""
          echo "Total topics from balance report: $TOTAL_FROM_BALANCE"
          if [ "$TOTAL_FROM_BALANCE" -ne 12 ]; then
            echo "✗ Balance report shows $TOTAL_FROM_BALANCE topics but expected 12"
            echo "This indicates duplicate counting or missing topics in LoadReports"
            exit 1
          fi
          echo "✓ Balance report topic count matches actual topics (12)"

      - name: "Phase 2: Manual Rebalancing Commands"
        env:
          DANUBE_ADMIN_ENDPOINT: http://127.0.0.1:50051
        run: |
          echo "========================================="
          echo "Phase 2: Manual Rebalancing Commands"
          echo "========================================="

          # Load broker IDs
          BROKER_1=$(cat broker-1-id.txt)
          BROKER_2=$(cat broker-2-id.txt)
          BROKER_3=$(cat broker-3-id.txt)

          # Get initial topic counts from balance report
          BALANCE_JSON=$(./target/release/danube-admin-cli brokers balance --output json)
          COUNT_B1_BEFORE=$(echo "$BALANCE_JSON" | jq -r --arg broker "$BROKER_1" '.brokers[] | select(.broker_id == ($broker | tonumber)) | .topic_count')
          COUNT_B2_BEFORE=$(echo "$BALANCE_JSON" | jq -r --arg broker "$BROKER_2" '.brokers[] | select(.broker_id == ($broker | tonumber)) | .topic_count')
          COUNT_B3_BEFORE=$(echo "$BALANCE_JSON" | jq -r --arg broker "$BROKER_3" '.brokers[] | select(.broker_id == ($broker | tonumber)) | .topic_count')

          # Default to 0 if empty
          COUNT_B1_BEFORE=${COUNT_B1_BEFORE:-0}
          COUNT_B2_BEFORE=${COUNT_B2_BEFORE:-0}
          COUNT_B3_BEFORE=${COUNT_B3_BEFORE:-0}

          echo ""
          echo "Initial topic distribution:"
          echo "  Broker 1: $COUNT_B1_BEFORE topics"
          echo "  Broker 2: $COUNT_B2_BEFORE topics"
          echo "  Broker 3: $COUNT_B3_BEFORE topics"

          # Dry-run rebalancing (cluster already balanced, should report this)
          echo ""
          echo "=== Dry-run Rebalancing ==="
          ./target/release/danube-admin-cli brokers rebalance --dry-run

          # Verify dry-run didn't move anything
          COUNT_B1_AFTER_DRYRUN=$(./target/release/danube-admin-cli brokers balance --output json | \
            jq -r --arg broker "$BROKER_1" '.brokers[] | select(.broker_id == ($broker | tonumber)) | .topic_count')
          COUNT_B1_AFTER_DRYRUN=${COUNT_B1_AFTER_DRYRUN:-0}

          if [ "$COUNT_B1_BEFORE" -eq "$COUNT_B1_AFTER_DRYRUN" ]; then
            echo "✓ Dry-run did not move topics"
          else
            echo "✗ Dry-run should not move topics (before: $COUNT_B1_BEFORE, after: $COUNT_B1_AFTER_DRYRUN)"
            exit 1
          fi

          # Execute manual rebalancing (should report cluster is balanced, 0 moves)
          echo ""
          echo "=== Executing Manual Rebalancing ==="
          ./target/release/danube-admin-cli brokers rebalance --max-moves 4

          # Verify cluster remains balanced
          echo ""
          echo "Checking cluster balance after manual rebalancing..."
          ./target/release/danube-admin-cli brokers balance

          CV_AFTER=$(./target/release/danube-admin-cli brokers balance --output json | jq -r '.coefficient_of_variation')
          echo ""
          echo "CV after manual rebalancing: $CV_AFTER"

          if (( $(echo "$CV_AFTER < 0.30" | bc -l) )); then
            echo "✓ Cluster remains balanced (CV=$CV_AFTER)"
          else
            echo "✗ Cluster should remain balanced but CV=$CV_AFTER"
            exit 1
          fi

      - name: "Phase 3: Automatic Rebalancing"
        env:
          DANUBE_ADMIN_ENDPOINT: http://127.0.0.1:50051
        run: |
          echo "========================================="
          echo "Phase 3: Automatic Rebalancing"
          echo "========================================="

          # Load broker IDs
          BROKER_1=$(cat broker-1-id.txt)
          BROKER_2=$(cat broker-2-id.txt)
          BROKER_3=$(cat broker-3-id.txt)

          # Create new imbalance by unloading Broker 2
          echo ""
          echo "=== Creating new imbalance by unloading Broker 2 ==="
          ./target/release/danube-admin-cli brokers unload --broker-id $BROKER_2

          # Poll balance report until Broker 2 shows 0 topics (or timeout)
          echo ""
          echo "Waiting for balance report to update..."
          TIMEOUT=30
          ELAPSED=0
          COUNT_B2=-1

          while [ $ELAPSED -lt $TIMEOUT ]; do
            COUNT_B2=$(./target/release/danube-admin-cli brokers balance --output json | \
              jq -r --arg broker "$BROKER_2" '.brokers[] | select(.broker_id == ($broker | tonumber)) | .topic_count')
            COUNT_B2=${COUNT_B2:-0}
            
            if [ "$COUNT_B2" -eq 0 ]; then
              echo "✓ Balance report updated: Broker 2 now has 0 topics (after ${ELAPSED}s)"
              break
            fi
            
            echo "  Polling... Broker 2 still shows $COUNT_B2 topics (${ELAPSED}s/${TIMEOUT}s)"
            sleep 2
            ELAPSED=$((ELAPSED + 2))
          done

          # Verify Broker 2 is empty
          echo ""
          echo "Checking final cluster balance after unload..."
          ./target/release/danube-admin-cli brokers balance

          echo ""
          echo "Topics on Broker 2 after unload: $COUNT_B2"

          if [ "$COUNT_B2" -eq 0 ]; then
            echo "✓ Broker 2 unloaded successfully"
          else
            echo "✗ Broker 2 should have 0 topics, has $COUNT_B2 (balance report may be stale)"
            echo "Checking actual topic assignments:"
            ./target/release/danube-admin-cli topics list --namespace default
            exit 1
          fi

          # Activate Broker 2 again
          echo ""
          echo "=== Activating Broker 2 ==="
          ./target/release/danube-admin-cli brokers activate --broker-id $BROKER_2

          # Check balance immediately after activation (should show imbalance)
          echo ""
          echo "Balance immediately after activation:"
          ./target/release/danube-admin-cli brokers balance

          CV_AFTER_ACTIVATE=$(./target/release/danube-admin-cli brokers balance --output json | jq -r '.coefficient_of_variation')
          echo ""
          echo "CV immediately after activation: $CV_AFTER_ACTIVATE"
          echo "Expected: CV > 0.20 (imbalanced, triggering automatic rebalancing)"

          # Poll for automatic rebalancing to redistribute topics and LoadReports to update
          # (check_interval: 5s for rebalancing, but LoadReports publish on their own schedule)
          echo ""
          echo "Waiting for automatic rebalancing and LoadReport updates..."
          TIMEOUT=60
          ELAPSED=0
          COUNT_B2_AFTER=0
          CV_AUTO=1.0

          while [ $ELAPSED -lt $TIMEOUT ]; do
            BALANCE_JSON=$(./target/release/danube-admin-cli brokers balance --output json)
            CV_AUTO=$(echo "$BALANCE_JSON" | jq -r '.coefficient_of_variation')
            COUNT_B2_AFTER=$(echo "$BALANCE_JSON" | jq -r --arg broker "$BROKER_2" '.brokers[] | select(.broker_id == ($broker | tonumber)) | .topic_count')
            COUNT_B2_AFTER=${COUNT_B2_AFTER:-0}
            
            # Check if rebalancing happened (CV improved and Broker 2 has topics)
            if [ "$COUNT_B2_AFTER" -gt 0 ] && (( $(echo "$CV_AUTO < 0.25" | bc -l) )); then
              echo "✓ Automatic rebalancing completed: Broker 2 has $COUNT_B2_AFTER topics, CV=$CV_AUTO (after ${ELAPSED}s)"
              break
            fi
            
            echo "  Polling... Broker 2: $COUNT_B2_AFTER topics, CV: $CV_AUTO (${ELAPSED}s/${TIMEOUT}s)"
            sleep 10
            ELAPSED=$((ELAPSED + 10))
          done

          # Verify automatic rebalancing worked
          echo ""
          echo "Checking final cluster balance after automatic rebalancing..."
          ./target/release/danube-admin-cli brokers balance

          echo ""
          echo "CV after automatic rebalancing: $CV_AUTO"
          echo "Topics on Broker 2 after automatic rebalancing: $COUNT_B2_AFTER"

          if (( $(echo "$CV_AUTO < 0.25" | bc -l) )); then
            echo "✓ Cluster rebalanced (CV=$CV_AUTO)"
          else
            echo "⚠ Cluster still imbalanced (CV=$CV_AUTO), may need more time"
          fi

          if [ "$COUNT_B2_AFTER" -gt 0 ]; then
            echo "✓ Broker 2 has $COUNT_B2_AFTER topics after automatic rebalancing"
          else
            echo "⚠ Broker 2 still has no topics, automatic rebalancing may need more time"
          fi

      - name: "Final Verification"
        if: always()
        env:
          DANUBE_ADMIN_ENDPOINT: http://127.0.0.1:50051
        run: |
          echo "========================================="
          echo "Final Verification"
          echo "========================================="

          # Final balance check
          echo ""
          echo "=== Final Cluster State ==="
          ./target/release/danube-admin-cli brokers balance || true

          # List all topics
          echo ""
          echo "=== All Topics ==="
          ./target/release/danube-admin-cli topics list --namespace default || true

          echo ""
          echo "✓ Rebalancing E2E test completed"
          echo "Note: Topics and brokers will be cleaned up automatically when workflow ends"

      - name: Collect etcd state on failure
        if: failure()
        run: |
          echo "=== ETCD State Dump ==="
          docker exec etcd-danube etcdctl get --prefix "" || echo "Failed to dump etcd state"
          echo "=== End ETCD State ==="

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: rebalancing-e2e-logs
          path: |
            broker-*.log
            *.log
            *.txt
