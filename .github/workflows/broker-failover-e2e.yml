name: Broker Failover E2E

on:
  pull_request:
    paths:
      - 'danube-broker/**'
      - '.github/workflows/broker-failover-e2e.yml'

jobs:
  build_and_test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq netcat-openbsd protobuf-compiler

      - name: Create certificate files
        run: |
          mkdir -p ./cert
          printf "%s" "${{ secrets.CERT_FILE }}" > ./cert/server-cert.pem
          printf "%s" "${{ secrets.KEY_FILE }}" > ./cert/server-key.pem
          printf "%s" "${{ secrets.CA_FILE }}" > ./cert/ca-cert.pem

      - name: Build workspace (release)
        run: cargo build --workspace --release

      - name: Start Broker A (single-node cluster)
        env:
          RUST_LOG: info,openraft=warn
        run: |
          mkdir -p danube-data
          nohup ./target/release/danube-broker \
            --config-file ./config/danube_broker.yml \
            --broker-addr 0.0.0.0:6650 \
            --admin-addr 0.0.0.0:50051 \
            --raft-addr 0.0.0.0:7650 \
            --data-dir ./danube-data/raft-1 \
            --prom-exporter 0.0.0.0:9040 \
            > broker-a.log 2>&1 &
          echo $! > broker-a.pid
          
          # Wait for Broker A admin and broker ports to be ready
          for i in {1..15}; do
            if nc -zv 127.0.0.1 50051 && nc -zv 127.0.0.1 6650; then
              echo "Broker A is ready."
              break
            elif [ $i -eq 15 ]; then
              echo "Broker A failed to start."
              cat broker-a.log
              exit 1
            fi
            echo "Waiting for Broker A to start... ($i/15)"
            sleep 3
          done

      - name: Provision namespace and topic via admin CLI
        env:
          DANUBE_ADMIN_ENDPOINT: http://127.0.0.1:50051
        run: |
          # Create failover test topic
          ./target/release/danube-admin topics create /default/failover-test
          
          # Verify topic was created successfully
          ./target/release/danube-admin topics describe /default/failover-test || {
            echo "ERROR: Topic creation failed"
            exit 1
          }
          echo "✓ Topic successfully created"

      - name: Start Broker B with --join (background)
        env:
          RUST_LOG: info,openraft=warn
        run: |
          nohup ./target/release/danube-broker \
            --config-file ./config/danube_broker.yml \
            --broker-addr 0.0.0.0:6651 \
            --admin-addr 0.0.0.0:50052 \
            --raft-addr 0.0.0.0:7651 \
            --data-dir ./danube-data/raft-2 \
            --prom-exporter 0.0.0.0:9041 \
            --join \
            > broker-b.log 2>&1 &
          echo $! > broker-b.pid
          
          # Wait for Broker B admin port to be ready (admin starts before cluster join)
          for i in {1..15}; do
            if nc -zv 127.0.0.1 50052; then
              echo "Broker B admin port is ready."
              break
            elif [ $i -eq 15 ]; then
              echo "Broker B admin port failed to start."
              cat broker-b.log
              exit 1
            fi
            echo "Waiting for Broker B admin port... ($i/15)"
            sleep 3
          done

      - name: Add Broker B to cluster via admin CLI
        env:
          DANUBE_ADMIN_ENDPOINT: http://127.0.0.1:50051
        run: |
          # Add Broker B as a Raft learner
          ./target/release/danube-admin cluster add-node --node-addr http://127.0.0.1:50052
          sleep 2
          
          # Discover Broker B's node_id from its own admin endpoint
          BROKER_B_NODE_ID=$(DANUBE_ADMIN_ENDPOINT=http://127.0.0.1:50052 \
            ./target/release/danube-admin cluster status 2>&1 | grep 'Self Node ID' | awk '{print $NF}')
          echo "Broker B node_id: $BROKER_B_NODE_ID"
          
          # Promote Broker B to voter
          ./target/release/danube-admin cluster promote-node --node-id $BROKER_B_NODE_ID
          
          # Wait for Broker B broker port to come up (it starts after joining cluster)
          for i in {1..15}; do
            if nc -zv 127.0.0.1 6651; then
              echo "Broker B is fully ready."
              break
            elif [ $i -eq 15 ]; then
              echo "Broker B broker port failed to start after joining."
              cat broker-b.log
              exit 1
            fi
            echo "Waiting for Broker B broker port... ($i/15)"
            sleep 3
          done
          
          # Activate Broker B so it can receive topics
          # First get Broker B's broker_id (same as node_id)
          ./target/release/danube-admin brokers activate --broker-id $BROKER_B_NODE_ID --reason "failover-test"
          echo "✓ Broker B added to cluster, promoted, and activated"
          
          # Give brokers time to sync
          sleep 5

      - name: Simulate Broker A failure
        run: |
          echo "Killing Broker A to simulate failure..."
          if [ -f broker-a.pid ]; then
            BROKER_A_PID=$(cat broker-a.pid)
            kill $BROKER_A_PID || echo "Broker A process may have already exited"
            sleep 2
            kill -9 $BROKER_A_PID 2>/dev/null || echo "Force kill not needed"
          fi
          echo "✓ Broker A terminated"

      - name: Wait for topic reassignment to Broker B
        env:
          DANUBE_ADMIN_ENDPOINT: http://127.0.0.1:50052
        run: |
          echo "Waiting for topic reassignment to Broker B..."
          REASSIGNMENT_TIMEOUT=60
          ELAPSED=0
          
          while [ $ELAPSED -lt $REASSIGNMENT_TIMEOUT ]; do
            echo "Checking reassignment progress... ($((ELAPSED/5 + 1))/12)"
            
            # Sync file to ensure all writes are flushed
            sync
            
            # Check Broker B logs for topic assignment messages (multiple patterns for robustness)
            if grep -qE "(topic created on broker.*failover-test|worker adding topic.*failover-test)" broker-b.log 2>/dev/null; then
              echo "✓ Topic successfully reassigned to Broker B (found in logs)"
              break
            elif [ $ELAPSED -ge $((REASSIGNMENT_TIMEOUT - 5)) ]; then
              echo "ERROR: Topic reassignment to Broker B timed out"
              echo "=== Broker B Logs ==="
              cat broker-b.log
              echo "=== End Broker B Logs ==="
              exit 1
            fi
            
            sleep 5
            ELAPSED=$((ELAPSED + 5))
          done

      - name: Verify Broker B is operational
        env:
          DANUBE_ADMIN_ENDPOINT: http://127.0.0.1:50052
        run: |
          echo "Verifying Broker B is operational after failover..."
          
          # Verify broker B is responding to admin commands
          ./target/release/danube-admin brokers list || {
            echo "ERROR: Broker B not responding to admin commands"
            cat broker-b.log
            exit 1
          }
          
          # Verify topic is accessible on Broker B
          ./target/release/danube-admin topics describe /default/failover-test || {
            echo "ERROR: Topic not accessible on Broker B"
            cat broker-b.log
            exit 1
          }
          
          echo "✓ Broker B is operational and serving the failover topic"

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: broker-failover-logs
          path: |
            broker-a.log
            broker-b.log
            failover_test
            *.rs
